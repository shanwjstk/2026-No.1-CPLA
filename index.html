<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í˜„ì¶œì—°ìŠµ ì›¹ì•± â€“ ë¼ì´íŠ¸ í…Œë§ˆ + ë°˜ë³µí•™ìŠµ</title>
<style>
  :root{
    /* ë¼ì´íŠ¸ íŒ”ë ˆíŠ¸ */
    --bg:#f7fafc;            /* ë°°ê²½ */
    --panel:#ffffff;         /* ì¹´ë“œ ë°°ê²½ */
    --line:#e2e8f0;          /* í…Œë‘ë¦¬ */
    --shadow:0 8px 22px rgba(15, 23, 42, .08);

    --text:#0f172a;          /* ë³¸ë¬¸ ê¸€ì */
    --muted:#64748b;         /* ë³´ì¡° ê¸€ì */

    --brand:#2563eb;         /* í¬ì¸íŠ¸(íŒŒë‘) */
    --good:#16a34a;          /* ì •ë‹µ(ì´ˆë¡) */
    --bad:#dc2626;           /* ì˜¤ë‹µ(ë¹¨ê°•) */
    --warn:#d97706;          /* ë¶€ë¶„ì •ë‹µ(ì£¼í™©) */

    --chip-bg:#f1f5f9;       /* ì¹©/ë±ƒì§€ ë°°ê²½ */
    --chip-line:#e2e8f0;     /* ì¹©/ë±ƒì§€ í…Œë‘ë¦¬ */
    --hint-bg:#f8fafc;       /* íŒíŠ¸ ë°°ê²½ */
    --meter-bg:#eef2f7;      /* ê²Œì´ì§€ ë°” ë°°ê²½ */
  }

  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif
  }
  .wrap{max-width:1200px;margin:28px auto;padding:20px}
  h1{font-size:24px;margin:0 0 6px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:18px}

  .grid{display:grid;grid-template-columns:380px 1fr;gap:16px}
  .card{
    background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)
  }
  .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .bd{padding:14px 16px}
  .muted{color:var(--muted)}

  input[type=text],textarea,select{
    width:100%;background:#ffffff;border:1px solid var(--line);
    border-radius:12px;color:var(--text);padding:11px 12px;font-size:14px;outline:none
  }
  textarea{min-height:96px;resize:vertical}
  input:focus,textarea:focus,select:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:#c7d2fe}

  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}

  .btn{
    border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-weight:700;font-size:14px;cursor:pointer;
    background:#ffffff;color:var(--text);transition:transform .03s, background .15s
  }
  .btn:hover{background:#f8fafc}
  .btn:active{transform:translateY(1px)}
  .btn-primary{
    background:linear-gradient(180deg,#3b82f6,#2563eb);color:#fff;border-color:#1d4ed8
  }
  .btn-primary:hover{filter:brightness(.98)}
  .btn-danger{
    background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff;border-color:#b91c1c
  }
  .btn-chip{border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px;background:var(--chip-bg)}

  .list{max-height:420px;overflow:auto;padding-right:6px}
  .item{
    padding:10px;border:1px solid var(--line);background:#ffffff;border-radius:12px;margin:8px 0;display:flex;align-items:center;gap:8px
  }
  .tag{
    display:inline-block;border:1px solid var(--chip-line);background:var(--chip-bg);color:#0f172a;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;font-size:12px
  }

  .sep{height:1px;background:var(--line);margin:12px 0}

  .hint{
    background:var(--hint-bg);border:1px dashed var(--line);border-radius:12px;padding:10px
  }

  .meter{height:14px;background:var(--meter-bg);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,#22c55e,#84cc16);width:0%}

  .status{
    margin-top:10px;border-radius:14px;padding:12px;border:1px solid;display:flex;align-items:center;gap:10px;font-weight:700
  }
  .ok{background:#ecfdf5;border-color:#86efac;color:#065f46}       /* ì´ˆë¡ í†¤ */
  .ng{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}       /* ë¹¨ê°• í†¤ */
  .warn{background:#fffbeb;border-color:#fde68a;color:#7c2d12}     /* ì£¼í™© í†¤ */

  .badge{
    display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;border:1px solid var(--chip-line);
    background:var(--chip-bg);font-size:12px
  }
  .pill{
    display:inline-flex;gap:8px;align-items:center;border:1px solid var(--chip-line);
    background:var(--chip-bg);border-radius:999px;padding:6px 10px
  }
  .mini{font-size:12px}
  .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>í˜„ì¶œì—°ìŠµ ì›¹ì•±</h1>
    <div class="sub">ì œëª© & ì£¼ìš” í‚¤ì›Œë“œ ê¸°ë°˜ ì„œìˆ í˜• ëŒ€ë¹„ â€” <b style="color:var(--brand)">ì •ì˜¤ë‹µ ê°•ì¡°</b> + <b style="color:var(--brand)">60% ì´í•˜ ë°˜ë³µí•™ìŠµ</b></div>

    <div class="grid">
      <!-- ì¢Œì¸¡: ì„¸íŠ¸ ê´€ë¦¬ -->
      <section class="card">
        <div class="hd">
          <strong>ì„¸íŠ¸ ë§Œë“¤ê¸°/ê´€ë¦¬</strong>
          <div class="right">
            <button class="btn" id="exportBtn">ë‚´ë³´ë‚´ê¸°</button>
            <label class="btn" for="importFile">ê°€ì ¸ì˜¤ê¸°</label>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <label class="pill mini"><input type="checkbox" id="mergeImport" checked> ë³‘í•© ê°€ì ¸ì˜¤ê¸°</label>
          </div>
        </div>
        <div class="bd">
          <div class="note">í‚¤ì›Œë“œëŠ” ì‰¼í‘œ(, )ë¡œ êµ¬ë¶„. ì˜ˆ: ê³µì •ë ¥, ì²˜ë¶„ì„±, ì œì†Œê¸°ê°„</div>
          <div style="height:8px"></div>
          <input id="title" type="text" placeholder="ì œëª© (ì˜ˆ: í–‰ì •í–‰ìœ„ì˜ ê³µì •ë ¥ê³¼ ì·¨ì†Œì†Œì†¡ì˜ ê´€ê³„)" />
          <div style="height:8px"></div>
          <textarea id="keywords" placeholder="ì£¼ìš” í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)"></textarea>
          <div style="height:8px"></div>
          <textarea id="refAnswer" placeholder="ì°¸ê³  ë‹µì•ˆ (ì„ íƒ)"></textarea>
          <div style="height:10px"></div>
          <div class="row">
            <button class="btn btn-primary" id="saveBtn">ì¶”ê°€/ì €ì¥</button>
            <button class="btn btn-danger" id="clearFormBtn">ì…ë ¥ ì§€ìš°ê¸°</button>
          </div>

          <div class="sep"></div>
          <div class="row" style="align-items:center">
            <span class="badge">ì„¸íŠ¸ ëª©ë¡</span>
            <span class="note" id="statsSummary">â€”</span>
          </div>
          <div class="list" id="list"></div>
        </div>
      </section>

      <!-- ìš°ì¸¡: ì—°ìŠµ ì˜ì—­ -->
      <section class="card">
        <div class="hd">
          <strong>í˜„ì¶œ ì—°ìŠµ</strong>
          <div class="right">
            <label class="pill mini"><input type="checkbox" id="weakOnly"> ë°˜ë³µí•™ìŠµ(â‰¤60%)</label>
            <label class="pill mini"><input type="checkbox" id="hintToggle" checked> íŒíŠ¸ í‘œì‹œ</label>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <select id="deckSelect"></select>
            <button class="btn btn-chip" id="shuffleBtn">ë¬´ì‘ìœ„</button>
            <button class="btn btn-chip" id="prevBtn">ì´ì „</button>
            <button class="btn btn-chip" id="nextBtn">ë‹¤ìŒ</button>
          </div>

          <div style="height:10px"></div>
          <div class="hint">
            <b id="qTitle">ì—°ìŠµí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</b>
            <span class="muted mini" id="qInfo"></span>
          </div>
          <div id="hintBox" class="hint mini" style="display:none;margin-top:10px"></div>

          <div style="height:10px"></div>
          <textarea id="answer" placeholder="ê¸°ì–µë‚˜ëŠ” í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ ê°„ë‹¨íˆ â†’ ë¬¸ì¥í™”. (Ctrl/âŒ˜+Enterë¡œ ì±„ì )"></textarea>

          <div style="height:10px"></div>
          <div class="row" style="align-items:center">
            <button class="btn btn-primary" id="gradeBtn">ì±„ì </button>
            <button class="btn" id="showRefBtn" style="flex:0 0 auto">ì°¸ê³  ë‹µì•ˆ ë³´ê¸°</button>
            <span class="badge" id="streakBadge">ì •ë‹µë¥  â€”</span>
          </div>

          <div style="height:12px"></div>
          <div class="meter"><div class="fill" id="meterFill"></div></div>

          <div id="statusBox" class="status warn" style="display:none">
            <span id="statusIcon">âš ï¸</span>
            <span id="statusText">ì±„ì  ëŒ€ê¸° ì¤‘â€¦</span>
          </div>

          <div style="height:8px"></div>
          <div id="miss" class="mini"></div>

          <div id="refWrap" style="display:none;margin-top:10px">
            <div class="mini muted">ì°¸ê³  ë‹µì•ˆ(ì „ì²´)</div>
            <pre id="refOut" class="mini" style="white-space:pre-wrap"></pre>
          </div>
        </div>
      </section>
    </div>

    <div class="sub">ì €ì¥ì€ ìë™(LocalStorage). ë‹¤ë¥¸ PC/ë¸Œë¼ìš°ì €ë¡œ ì˜®ê¸¸ ë• <b>ë‚´ë³´ë‚´ê¸°â†’ê°€ì ¸ì˜¤ê¸°</b> ì‚¬ìš©.</div>
  </div>

<script>
(function(){
  /* ===== ì €ì¥ í‚¤ ===== */
  var KEY='recallDecks.v1';
  var STATS_KEY='recallStats.v1'; // { [id]: {attempts, lastScore(0~1), correctCount} }

  /* ===== ìƒíƒœ ===== */
  var decks=[];       // [{id,title,keywords[],ref?}]
  var statsMap={};    // id -> stat
  var idx=-1;         // í˜„ì¬ ì¸ë±ìŠ¤
  var pool=[];        // í˜„ì¬ ì—°ìŠµ ëŒ€ìƒ ì¸ë±ìŠ¤ ëª©ë¡ (ì „ì²´ or 60% ì´í•˜)
  var weakMode=false; // ë°˜ë³µí•™ìŠµ ëª¨ë“œ(â‰¤60%)

  /* ===== ìœ í‹¸ ===== */
  function uid(){return Math.random().toString(36).slice(2,9)}
  function z(n){n=String(n);return ('0'+n).slice(-2)}
  function stamp(){var d=new Date();return d.getFullYear()+z(d.getMonth()+1)+z(d.getDate())+'-'+z(d.getHours())+z(d.getMinutes())+z(d.getSeconds())}
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];})}
  function parseKeywords(t){return String(t).split(',').map(function(s){return s.trim();}).filter(function(x){return !!x;});}
  function fmtTags(arr){return arr.map(function(k){return '<span class="tag">'+escapeHtml(k)+'</span>';}).join('')}
  function shuffleInPlace(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=a[i];a[i]=a[j];a[j]=tmp;}}

  function testStorage(){try{var t='__t'+Date.now();localStorage.setItem(t,'1');localStorage.removeItem(t);return true;}catch(e){return false;}}

  /* ===== ë¡œë“œ/ì„¸ì´ë¸Œ ===== */
  function load(){
    try{decks=JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){decks=[]}
    try{statsMap=JSON.parse(localStorage.getItem(STATS_KEY)||'{}')}catch(e){statsMap={}}
  }
  function save(){ try{localStorage.setItem(KEY, JSON.stringify(decks));}catch(e){} }
  function saveStats(){ try{localStorage.setItem(STATS_KEY, JSON.stringify(statsMap));}catch(e){} }

  /* ===== ë Œë” ===== */
  function renderList(){
    var list=document.getElementById('list'); list.innerHTML='';
    if(decks.length===0){list.innerHTML='<div class="muted mini">ì•„ì§ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>'; renderSelect(); renderSummary(); return;}
    for(var i=0;i<decks.length;i++){
      var d=decks[i], st=statsMap[d.id]||{attempts:0,lastScore:0,correctCount:0};
      var rate = st.attempts? Math.round(st.lastScore*100)+'%' : 'â€”';
      var div=document.createElement('div'); div.className='item';
      div.innerHTML =
        '<div style="flex:1">'+
        '<div><b>'+escapeHtml(d.title)+'</b></div>'+
        '<div class="mini muted">ìµœê·¼ ì •ë‹µë¥ : '+rate+' Â· ì‹œë„: '+st.attempts+'íšŒ</div>'+
        '<div>'+fmtTags(d.keywords)+'</div>'+
        '</div>'+
        '<button class="btn btn-chip" data-act="edit" data-i="'+i+'">ìˆ˜ì •</button>'+
        '<button class="btn btn-danger btn-chip" data-act="del" data-i="'+i+'">ì‚­ì œ</button>';
      list.appendChild(div);
    }
    renderSelect(); renderSummary();
  }

  function renderSelect(){
    var sel=document.getElementById('deckSelect');
    sel.innerHTML = decks.map(function(d,i){return '<option value="'+i+'">'+(i+1)+'. '+escapeHtml(d.title)+'</option>'}).join('');
  }

  function renderSummary(){
    var weak=0, tried=0, i, st;
    for(i=0;i<decks.length;i++){
      st = statsMap[decks[i].id];
      if(st && st.attempts>0){ tried++; if(st.lastScore<=0.6) weak++; }
    }
    var sum='ì „ì²´ '+decks.length+'ê°œ';
    if(tried>0) sum += ' Â· 60% ì´í•˜ '+weak+'ê°œ';
    document.getElementById('statsSummary').textContent = sum;
  }

  function buildPool(){
    pool=[];
    if(!weakMode){
      for(var i=0;i<decks.length;i++) pool.push(i);
    }else{
      for(var j=0;j<decks.length;j++){
        var st=statsMap[decks[j].id];
        if(st && st.attempts>0 && st.lastScore<=0.6) pool.push(j);
      }
      if(pool.length===0){
        document.getElementById('statusBox').style.display='flex';
        document.getElementById('statusBox').className='status ok';
        document.getElementById('statusIcon').textContent='âœ…';
        document.getElementById('statusText').textContent='ë°˜ë³µí•™ìŠµ ëŒ€ìƒ(â‰¤60%)ì´ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ëª¨ë“œë¡œ ì§„í–‰í•´ ë³´ì„¸ìš”.';
      }
    }
    if(pool.length>1) shuffleInPlace(pool);
  }

  function showByIndex(i){
    if(decks.length===0) return;
    idx = (i+decks.length)%decks.length;
    document.getElementById('deckSelect').value = String(idx);
    var d=decks[idx];
    document.getElementById('qTitle').textContent = d.title;
    document.getElementById('qInfo').textContent = 'Â· í‚¤ì›Œë“œ '+d.keywords.length+'ê°œ';
    document.getElementById('answer').value='';
    document.getElementById('meterFill').style.width='0%';
    document.getElementById('statusBox').style.display='none';
    document.getElementById('miss').innerHTML='';
    var hintOn=document.getElementById('hintToggle').checked;
    var box=document.getElementById('hintBox');
    if(hintOn && d.ref){ var t=String(d.ref); box.style.display='block'; box.textContent = t.length>160?t.slice(0,160)+'â€¦':t; }
    else { box.style.display='none'; box.textContent=''; }
    var st=statsMap[d.id]; var badge=document.getElementById('streakBadge');
    if(st && st.attempts>0){ badge.textContent='ìµœê·¼ ì •ë‹µë¥  '+Math.round(st.lastScore*100)+'% Â· ì‹œë„ '+st.attempts+'íšŒ'; }
    else { badge.textContent='ì •ë‹µë¥  â€”'; }
    document.getElementById('refWrap').style.display='none';
    document.getElementById('refOut').textContent='';
  }

  function showNext(step){
    if(decks.length===0) return;
    if(!weakMode){ showByIndex(idx+step); return; }
    if(pool.length===0){ showByIndex(idx+step); return; }
    var pIndex = pool.indexOf(idx);
    if(pIndex<0){ pIndex=0; }
    var nextIndex = (pIndex + (step>=0?1:-1) + pool.length) % pool.length;
    showByIndex(pool[nextIndex]);
  }

  /* ===== ì±„ì  ===== */
  function fmtPercent(x){ return Math.round(x*100)+'%'; }
  function grade(){
    if(idx<0) return;
    var d=decks[idx];
    var txt=String(document.getElementById('answer').value||'').toLowerCase();
    var hits=[], missed=[];
    for(var i=0;i<d.keywords.length;i++){
      var w=String(d.keywords[i]||'').toLowerCase();
      var re=new RegExp('(^|[^ê°€-í£A-Za-z0-9_])'+w+'([^ê°€-í£A-Za-z0-9_]|$)');
      if(re.test(txt) || txt.indexOf(w)>-1) hits.push(d.keywords[i]); else missed.push(d.keywords[i]);
    }
    var ratio = d.keywords.length ? (hits.length/d.keywords.length) : 0;

    var meter=document.getElementById('meterFill');
    meter.style.width = fmtPercent(ratio);

    var box=document.getElementById('statusBox');
    var icon=document.getElementById('statusIcon');
    var text=document.getElementById('statusText');
    var pass = ratio>=0.7; // í•©ê²©ì„  70%

    if(pass){
      box.className='status ok'; icon.textContent='âœ…';
      text.textContent='ì •ë‹µ â€” '+fmtPercent(ratio)+' ('+hits.length+'/'+d.keywords.length+')';
    }else if(ratio>0){
      box.className='status warn'; icon.textContent='ğŸŸ¡';
      text.textContent='ë¶€ë¶„ì •ë‹µ â€” '+fmtPercent(ratio)+' ('+hits.length+'/'+d.keywords.length+')';
    }else{
      box.className='status ng'; icon.textContent='âŒ';
      text.textContent='ì˜¤ë‹µ â€” 0% (0/'+d.keywords.length+')';
    }
    box.style.display='flex';

    document.getElementById('miss').innerHTML = missed.length? ('ëˆ„ë½: '+fmtTags(missed)) : '<span class="muted">ëˆ„ë½ ì—†ìŒ</span>';

    var st=statsMap[d.id]||{attempts:0,lastScore:0,correctCount:0};
    st.attempts+=1; st.lastScore=ratio; if(pass) st.correctCount+=1;
    statsMap[d.id]=st; saveStats(); renderList();

    if(weakMode){ buildPool(); }
    if(ratio<=0.6){ setTimeout(function(){ showNext(+1); }, 600); }
  }

  /* ===== ì´ë²¤íŠ¸ ===== */
  document.addEventListener('DOMContentLoaded', function(){
    if(!testStorage()){
      var warn = document.createElement('div');
      warn.className='card'; warn.style.margin='0 0 12px';
      warn.innerHTML='<div class="bd mini" style="color:#7f1d1d;background:#fef2f2;border:1px solid #fecaca;border-radius:14px"><b>ì£¼ì˜:</b> ë¸Œë¼ìš°ì €ê°€ ì €ì¥ê³µê°„ì„ ì œí•œí•˜ê³  ìˆì„ ìˆ˜ ìˆì–´ìš”(ì‹œí¬ë¦¿ ëª¨ë“œ/ì¢…ë£Œì‹œ ì¿ í‚¤ì‚­ì œ ì„¤ì •). <b>ë‚´ë³´ë‚´ê¸°</b>ë¡œ ìˆ˜ë™ ë°±ì—… ê¶Œì¥.</div>';
      document.querySelector('.wrap').insertBefore(warn, document.querySelector('.grid'));
    }

    load(); renderList();
    weakMode=document.getElementById('weakOnly').checked;
    buildPool();
    if(decks.length) showByIndex( (weakMode && pool.length)? pool[0]:0 );

    /* ì„¸íŠ¸ ì¡°ì‘ */
    document.getElementById('saveBtn').onclick=function(){
      var t=document.getElementById('title').value.trim();
      var ks=parseKeywords(document.getElementById('keywords').value);
      var ref=document.getElementById('refAnswer').value.trim();
      if(!t || ks.length===0){ alert('ì œëª©ê³¼ ìµœì†Œ 1ê°œì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      var fi=-1; for(var i=0;i<decks.length;i++){ if(decks[i].title===t){fi=i;break;} }
      if(fi>-1){ decks[fi].keywords=ks; decks[fi].ref=ref||undefined; }
      else { var id=uid(); decks.push({id:id,title:t,keywords:ks,ref:ref||undefined}); }
      save(); renderList(); buildPool();
      document.getElementById('title').value=''; document.getElementById('keywords').value=''; document.getElementById('refAnswer').value='';
      if(decks.length===1){ showByIndex(0); }
    };
    document.getElementById('clearFormBtn').onclick=function(){
      document.getElementById('title').value=''; document.getElementById('keywords').value=''; document.getElementById('refAnswer').value='';
    };
    document.getElementById('list').onclick=function(e){
      var t=e.target; while(t && t.tagName!=='BUTTON'){ t=t.parentNode; } if(!t) return;
      var i=+t.getAttribute('data-i'); var act=t.getAttribute('data-act');
      if(act==='del'){ if(confirm('ì‚­ì œí• ê¹Œìš”?')){ var del=decks.splice(i,1)[0]; delete statsMap[del.id]; save(); saveStats(); renderList(); buildPool(); if(decks.length){ showByIndex(0);} } }
      if(act==='edit'){ var d=decks[i]; document.getElementById('title').value=d.title; document.getElementById('keywords').value=d.keywords.join(', '); document.getElementById('refAnswer').value=d.ref||''; }
    };

    /* ì—°ìŠµ ë„¤ë¹„ */
    document.getElementById('deckSelect').onchange=function(e){ showByIndex(+e.target.value); };
    document.getElementById('nextBtn').onclick=function(){ showNext(+1); };
    document.getElementById('prevBtn').onclick=function(){ showNext(-1); };
    document.getElementById('shuffleBtn').onclick=function(){
      if(!weakMode){ var order=[]; for(var i=0;i<decks.length;i++) order.push(i); shuffleInPlace(order); decks = order.map(function(i){return decks[i];}); save(); renderList(); showByIndex(0); }
      else { shuffleInPlace(pool); if(pool.length) showByIndex(pool[0]); }
    };

    /* ì±„ì /íŒíŠ¸ */
    document.getElementById('gradeBtn').onclick=grade;
    document.getElementById('hintToggle').onchange=function(){
      if(idx<0) return; var d=decks[idx]; var box=document.getElementById('hintBox');
      if(this.checked && d && d.ref){ var t=String(d.ref); box.style.display='block'; box.textContent=t.length>160?t.slice(0,160)+'â€¦':t; }
      else{ box.style.display='none'; box.textContent=''; }
    };
    document.getElementById('showRefBtn').onclick=function(){
      if(idx<0) return; var d=decks[idx]; if(!d.ref){ alert('ë“±ë¡ëœ ì°¸ê³  ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      document.getElementById('refWrap').style.display='block';
      document.getElementById('refOut').textContent = d.ref;
    };

    /* ë°˜ë³µí•™ìŠµ í† ê¸€ */
    document.getElementById('weakOnly').onchange=function(){
      weakMode=this.checked; buildPool();
      if(weakMode && pool.length){ showByIndex(pool[0]); }
      else if(!weakMode && decks.length){ showByIndex(0); }
    };

    /* ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° */
    document.getElementById('exportBtn').onclick=function(){
      var name='recall-decks-'+stamp()+'.json';
      var blob=new Blob([JSON.stringify(decks,null,2)],{type:'application/json'});
      var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name; a.click();
      setTimeout(function(){URL.revokeObjectURL(url)},1500);
    };
    document.getElementById('importFile').onchange=function(e){
      var f=e.target.files && e.target.files[0]; if(!f) return;
      var rd=new FileReader();
      rd.onload=function(){
        try{
          var data=JSON.parse(String(rd.result));
          if(Object.prototype.toString.call(data)!=='[object Array]') throw new Error('í˜•ì‹ ì˜¤ë¥˜');
          var incoming=data.map(function(x){return {id:(x.id||uid()), title:String(x.title||''), keywords:(x.keywords||[]).map(String), ref:(x.ref?String(x.ref):undefined)};});
          if(document.getElementById('mergeImport').checked){
            var map={}, i; for(i=0;i<decks.length;i++){ map[decks[i].title]=decks[i]; }
            for(i=0;i<incoming.length;i++){
              var nd=incoming[i], ex=map[nd.title];
              if(ex){
                var bag={}, merged=[], a1=(ex.keywords||[]), a2=(nd.keywords||[]);
                var p; for(p=0;p<a1.length;p++){ if(!bag[a1[p]]){ bag[a1[p]]=1; merged.push(a1[p]); } }
                for(p=0;p<a2.length;p++){ if(!bag[a2[p]]){ bag[a2[p]]=1; merged.push(a2[p]); } }
                ex.keywords=merged;
                if(!ex.ref && nd.ref) ex.ref=nd.ref;
              }else{ decks.push(nd); }
            }
          }else{
            decks=incoming; statsMap={}; // ì™„ì „ êµì²´ ì‹œ í†µê³„ ì´ˆê¸°í™”
          }
          save(); renderList(); buildPool(); if(decks.length){ showByIndex(0); }
        }catch(err){ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+err.message); }
      };
      rd.readAsText(f,'utf-8');
      e.target.value='';
    };

    /* ë‹¨ì¶•í‚¤ */
    window.addEventListener('keydown', function(ev){
      var enter = (ev.key==='Enter' || ev.keyCode===13);
      if((ev.ctrlKey||ev.metaKey) && enter){ grade(); ev.preventDefault(); }
    });
  });
})();
</script>
</body>
</html>
