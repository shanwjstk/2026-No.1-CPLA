<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í˜„ì¶œì—°ìŠµ â€“ ê³¼ëª©ë³„ ê´€ë¦¬(ìµœëŒ€ 5ê³¼ëª©)</title>
<style>
  :root{
    --bg:#ffffff; --panel:#ffffff; --line:#e5e7eb; --shadow:0 10px 28px rgba(2,6,23,.06);
    --text:#0f172a; --muted:#64748b;
    --brand:#0064ff; --brand-strong:#004fe0;
    --good:#12b886; --bad:#ef4444; --warn:#f59e0b;
    --chip-bg:#f8fafc; --chip-line:#e5e7eb;
    --hint-bg:#f8fafc; --meter-bg:#eef4ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Pretendard,Apple SD Gothic Neo,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .topbar{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:-.2px}
  .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
  .brand-title{font-size:18px;color:var(--brand-strong)}

  .wrap{max-width:1200px;margin:24px auto;padding:0 20px 20px}
  h1{font-size:28px;margin:10px 0 6px;font-weight:800;letter-spacing:-.3px}
  .sub{color:var(--muted);font-size:14px;margin-bottom:18px}

  /* ê³¼ëª© íƒ­ë°” */
  .subjects{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 16px}
  .sub-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--chip-line);background:#fff;font-weight:800;font-size:13px;cursor:pointer}
  .sub-pill.active{background:var(--brand);color:#fff;border-color:#0057e6;box-shadow:0 6px 16px rgba(0,100,255,.16)}
  .sub-pill .mini-btn{font-weight:800;border:none;background:transparent;color:inherit;cursor:pointer}
  .sub-add{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px dashed var(--chip-line);background:#fff;font-weight:800;font-size:13px;color:var(--brand);cursor:pointer}

  .grid{display:grid;grid-template-columns:380px 1fr;gap:20px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;border-bottom:1px solid var(--line);background:#fbfbfd}
  .bd{padding:16px 18px}
  .note{color:var(--muted);font-size:13px}

  input,textarea,select{
    width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:14px;background:#fff;color:var(--text);
    outline:none;transition:border-color .2s, box-shadow .2s
  }
  input:focus,textarea:focus,select:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(0,100,255,.18)}
  textarea{min-height:96px;resize:vertical}
  .row{display:flex;gap:12px;align-items:center}.row>*{flex:1}
  .sep{height:1px;background:var(--line);margin:16px 0}

  /* ë²„íŠ¼ */
  .btn{--btn-bg:#fff;--btn-fg:var(--text);--btn-border:var(--line);
    position:relative;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;
    border:1px solid var(--btn-border);background:var(--btn-bg);color:var(--btn-fg);font-weight:800;letter-spacing:-.2px;font-size:14px;cursor:pointer;
    transition:transform .08s, box-shadow .2s, background .2s, border-color .2s;box-shadow:0 1px 0 rgba(2,6,23,.03), 0 8px 16px rgba(2,6,23,.04)
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(2,6,23,.08)}
  .btn:active{transform:translateY(0);box-shadow:0 4px 12px rgba(2,6,23,.06)}
  .btn-primary{--btn-bg:linear-gradient(180deg,#3b82f6,#0064ff);--btn-fg:#fff;--btn-border:#0057e6;box-shadow:0 8px 18px rgba(0,100,255,.22)}
  .btn-primary::after{content:"";position:absolute;inset:0;border-radius:12px;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,0));opacity:.75}
  .btn-danger{--btn-bg:linear-gradient(180deg,#f87171,#ef4444);--btn-fg:#fff;--btn-border:#dc2626;box-shadow:0 8px 18px rgba(239,68,68,.18)}
  .btn-ghost{--btn-bg:#fff;--btn-border:var(--chip-line)}
  .btn-chip{--btn-bg:#fff;--btn-border:var(--chip-line);padding:8px 12px;border-radius:999px;font-size:12px;font-weight:800}

  /* ë¦¬ìŠ¤íŠ¸ & íƒœê·¸ */
  .list{max-height:460px;overflow:auto;padding-right:6px}
  .item{display:flex;align-items:center;gap:10px;padding:12px;margin:10px 0;background:#fff;border:1px solid var(--line);border-radius:14px}
  .tag{display:inline-block;border:1px solid var(--chip-line);background:var(--chip-bg);color:var(--text);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}

  /* íŒíŠ¸/ê²Œì´ì§€/ì •ì˜¤ë‹µ */
  .hint{background:var(--hint-bg);border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:8px}
  .meter{height:14px;background:var(--meter-bg);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,#60a5fa,#0064ff);width:0%}
  .status{margin-top:10px;border-radius:14px;padding:12px;border:1px solid;display:flex;align-items:center;gap:10px;font-weight:800}
  .ok{background:#eff8ff;border-color:#bfdbfe;color:#0b3ea8}
  .ng{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
  .warn{background:#fff7ed;border-color:#fed7aa;color:#7c2d12}

  /* ëˆ„ë½ í‚¤ì›Œë“œ ê°•ì¡°(ë¶‰ì€ ì¹©) */
  .miss-line{margin-top:6px}
  .miss-tag{display:inline-block;border:1px solid #fecaca;background:#fef2f2;color:#b91c1c;border-radius:999px;padding:5px 9px;font-size:12px;font-weight:800;margin:3px 6px 0 0}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand"><div class="brand-dot"></div><div class="brand-title">í˜„ì¶œì—°ìŠµ</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" id="exportBtn">ë‚´ë³´ë‚´ê¸°</button>
      <label class="btn btn-ghost" for="importFile">ê°€ì ¸ì˜¤ê¸°</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </div>
</header>

<main class="wrap">
  <h1>í‚¤ì›Œë“œ ê¸°ë°˜ ì„œìˆ í˜• ëŒ€ë¹„</h1>
  <div class="sub">ê³¼ëª©ë³„ë¡œ ì„¸íŠ¸/í†µê³„ë¥¼ **ì™„ì „ ë¶„ë¦¬**í•´ ê´€ë¦¬í•˜ì„¸ìš”. (ìµœëŒ€ 5ê³¼ëª©)</div>

  <!-- ê³¼ëª© íƒ­ -->
  <div id="subjectBar" class="subjects"></div>

  <div class="grid">
    <!-- ì™¼ìª½: ì„¸íŠ¸ ê´€ë¦¬ -->
    <section class="card">
      <div class="hd">
        <strong id="leftTitle">ì„¸íŠ¸ ë§Œë“¤ê¸°</strong>
        <span class="note">ìë™ ì €ì¥(LocalStorage)</span>
      </div>
      <div class="bd">
        <div class="note">í‚¤ì›Œë“œëŠ” ì‰¼í‘œ(, )ë¡œ êµ¬ë¶„. ì˜ˆ: ê³µì •ë ¥, ì²˜ë¶„ì„±, ì œì†Œê¸°ê°„</div>
        <div style="height:8px"></div>
        <input id="title" type="text" placeholder="ì œëª© (ì˜ˆ: í–‰ì •í–‰ìœ„ì˜ ê³µì •ë ¥ê³¼ ì·¨ì†Œì†Œì†¡)" />
        <div style="height:8px"></div>
        <textarea id="keywords" placeholder="ì£¼ìš” í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)"></textarea>
        <div style="height:8px"></div>
        <textarea id="refAnswer" placeholder="ì°¸ê³  ë‹µì•ˆ (ì„ íƒ)"></textarea>

        <div style="height:12px"></div>
        <div class="row">
          <button class="btn btn-primary" id="saveBtn">ì¶”ê°€/ì €ì¥</button>
          <button class="btn btn-danger" id="clearFormBtn">ì…ë ¥ ì§€ìš°ê¸°</button>
        </div>

        <div class="sep"></div>
        <div class="row" style="align-items:center">
          <strong>ì„¸íŠ¸ ëª©ë¡</strong>
          <span id="statsSummary" class="note" style="text-align:right"></span>
        </div>
        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ì—°ìŠµ í™”ë©´ -->
    <section class="card">
      <div class="hd">
        <strong>í˜„ì¶œ ì—°ìŠµ</strong>
        <div class="row" style="flex:0 0 auto">
          <label class="btn btn-chip" style="gap:8px"><input type="checkbox" id="weakOnly"> ë°˜ë³µí•™ìŠµ(â‰¤60%)</label>
          <label class="btn btn-chip" style="gap:8px"><input type="checkbox" id="hintToggle" checked> íŒíŠ¸ í‘œì‹œ</label>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <select id="deckSelect"></select>
          <button class="btn btn-chip" id="prevBtn">ì´ì „</button>
          <button class="btn btn-chip" id="nextBtn">ë‹¤ìŒ</button>
        </div>

        <div class="hint">
          <b id="qTitle">ì—°ìŠµí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</b>
          <span class="note mini" id="qInfo"></span>
        </div>
        <div id="hintBox" class="hint mini" style="display:none"></div>

        <div style="height:8px"></div>
        <textarea id="answer" placeholder="ê¸°ì–µë‚˜ëŠ” í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ ê°„ë‹¨íˆ â†’ ë¬¸ì¥í™”. (Ctrl/âŒ˜+Enterë¡œ ì±„ì )"></textarea>

        <div style="height:10px"></div>
        <div class="row" style="align-items:center">
          <button class="btn btn-primary" id="gradeBtn">ì±„ì </button>
          <button class="btn btn-ghost" id="showRefBtn" style="flex:0 0 auto">ì°¸ê³  ë‹µì•ˆ</button>
          <span id="streakBadge" class="note" style="flex:0 0 auto">ì •ë‹µë¥  â€”</span>
        </div>

        <div style="height:12px"></div>
        <div class="meter"><div id="meterFill" class="fill"></div></div>

        <div id="statusBox" class="status warn" style="display:none">
          <span id="statusIcon">âš ï¸</span><span id="statusText">ì±„ì  ëŒ€ê¸° ì¤‘â€¦</span>
        </div>

        <div id="miss" class="miss-line"></div>

        <div id="refWrap" style="display:none;margin-top:10px">
          <div class="note mini">ì°¸ê³  ë‹µì•ˆ(ì „ì²´)</div>
          <pre id="refOut" class="note mini" style="white-space:pre-wrap"></pre>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
/* ================= ë°ì´í„° êµ¬ì¡° (ê³¼ëª©ë³„) =================
db = { active: 0, subjects: [
  { id, name, decks: [{id,title,keywords[],ref?}], stats: { [deckId]: {attempts,lastScore} } }
]}
========================================================= */
var DB_KEY='recallSubjects.v1';
var LEGACY_KEY='recallDecks.v1'; // v1 ë§ˆì´ê·¸ë ˆì´ì…˜
var db={active:0, subjects:[]};
var idx=-1; // í˜„ì¬ ë¬¸í•­ ì¸ë±ìŠ¤(í™œì„± ê³¼ëª© ê¸°ì¤€)
var pool=[]; var weakMode=false;

function uid(){return Math.random().toString(36).slice(2,9)}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];})}
function parseKeywords(t){return String(t).split(',').map(function(s){return s.trim();}).filter(function(x){return !!x;});}
function getS(){ return db.subjects[db.active]; }
function save(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

function migrateIfNeeded(){
  if(localStorage.getItem(DB_KEY)) return;
  var legacy = null;
  try{ legacy = JSON.parse(localStorage.getItem(LEGACY_KEY)||'null'); }catch(e){ legacy=null; }
  if(legacy && Object.prototype.toString.call(legacy)==='[object Array]'){
    db.subjects=[{id:uid(), name:'ê¸°ë³¸', decks: legacy.map(function(x){return {id:(x.id||uid()), title:x.title, keywords:x.keywords||[], ref:x.ref};}), stats:{}}];
    db.active=0; save();
  }else{
    // ì´ˆê¸° ê³¼ëª© 1ê°œë§Œ ìƒì„±
    db.subjects=[{id:uid(), name:'ê³¼ëª©1', decks:[], stats:{}}];
    db.active=0; save();
  }
}

/* ================= ë Œë”: ê³¼ëª© ë°” ================= */
function renderSubjectBar(){
  var bar=document.getElementById('subjectBar'); bar.innerHTML='';
  for(var i=0;i<db.subjects.length;i++){
    (function(i){
      var s=db.subjects[i];
      var b=document.createElement('button');
      b.className='sub-pill'+(i===db.active?' active':'');
      b.innerHTML = '<span>'+escapeHtml(s.name)+'</span>'+
                    (i===db.active? ' <button class="mini-btn" title="ì´ë¦„ë³€ê²½" data-act="rename">âœ</button>' +
                                     ' <button class="mini-btn" title="ë¹„ì–´ìˆì„ ë•Œë§Œ ì‚­ì œ" data-act="del">ğŸ—‘</button>' : '');
      b.onclick=function(e){
        var act=e.target.getAttribute('data-act');
        if(act==='rename'){
          var nn=prompt('ê³¼ëª© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', s.name);
          if(nn && nn.trim()){
            s.name=nn.trim(); save(); renderSubjectBar(); renderAll();
          }
          return;
        }
        if(act==='del'){
          if(s.decks.length>0){ alert('ì„¸íŠ¸ê°€ ë‚¨ì•„ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¸íŠ¸ë¥¼ ë¹„ì›Œì£¼ì„¸ìš”.'); return; }
          if(db.subjects.length<=1){ alert('ìµœì†Œ 1ê°œ ê³¼ëª©ì€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
          if(confirm('ê³¼ëª©ì„ ì‚­ì œí• ê¹Œìš”?')){ db.subjects.splice(i,1); if(db.active>=db.subjects.length) db.active=db.subjects.length-1; save(); renderSubjectBar(); renderAll(); }
          return;
        }
        db.active=i; save(); renderSubjectBar(); renderAll();
      };
      bar.appendChild(b);
    })(i);
  }
  // ê³¼ëª© ì¶”ê°€ ë²„íŠ¼
  var add=document.createElement('button');
  add.className='sub-add';
  add.textContent = (db.subjects.length>=5)? 'ìµœëŒ€ 5ê³¼ëª©' : '+ ê³¼ëª© ì¶”ê°€';
  add.disabled = db.subjects.length>=5;
  add.onclick=function(){
    if(db.subjects.length>=5){ return; }
    var nm=prompt('ì¶”ê°€í•  ê³¼ëª© ì´ë¦„ (ì˜ˆ: í—Œë²• / í–‰ì •ë²• / ë¯¼ë²• / í˜•ë²• / ìƒë²•)');
    if(nm && nm.trim()){
      db.subjects.push({id:uid(), name:nm.trim(), decks:[], stats:{}});
      db.active=db.subjects.length-1; save(); renderSubjectBar(); renderAll();
    }
  };
  bar.appendChild(add);
}

/* ================= ë Œë”: ê³¼ëª© ë‚´ë¶€(ì„¸íŠ¸/ì—°ìŠµ) ================= */
function renderList(){
  var s=getS(); var list=document.getElementById('list'); list.innerHTML='';
  if(!s || !s.decks.length){ list.innerHTML='<div class="note">ì´ ê³¼ëª©ì—ëŠ” ì•„ì§ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>'; renderSelect(); renderSummary(); return; }
  for(var i=0;i<s.decks.length;i++){
    var d=s.decks[i], st=s.stats[d.id]||{attempts:0,lastScore:0};
    var rate=st.attempts? Math.round(st.lastScore*100)+'%' : 'â€”';
    var div=document.createElement('div'); div.className='item';
    div.innerHTML =
      '<div style="flex:1">'+
      '<div style="font-weight:800">'+escapeHtml(d.title)+'</div>'+
      '<div class="note" style="font-size:12px">ìµœê·¼ ì •ë‹µë¥ : '+rate+' Â· ì‹œë„: '+st.attempts+'íšŒ</div>'+
      '<div style="margin-top:2px">'+d.keywords.map(function(k){return '<span class="tag">'+escapeHtml(k)+'</span>'}).join('')+'</div>'+
      '</div>'+
      '<button class="btn btn-ghost" data-act="edit" data-i="'+i+'">ìˆ˜ì •</button>'+
      '<button class="btn btn-danger" data-act="del" data-i="'+i+'">ì‚­ì œ</button>';
    list.appendChild(div);
  }
  renderSelect(); renderSummary();
}
function renderSelect(){
  var s=getS(); var sel=document.getElementById('deckSelect');
  if(!s){ sel.innerHTML=''; return; }
  sel.innerHTML = s.decks.map(function(d,i){return '<option value="'+i+'">'+(i+1)+'. '+escapeHtml(d.title)+'</option>'}).join('');
}
function renderSummary(){
  var s=getS(); if(!s){ document.getElementById('statsSummary').textContent=''; return; }
  var weak=0,tried=0,i,st;
  for(i=0;i<s.decks.length;i++){ st=s.stats[s.decks[i].id]; if(st && st.attempts>0){ tried++; if(st.lastScore<=0.6) weak++; } }
  var sum='ì´ '+s.decks.length+'ê°œ'; if(tried>0) sum+=' Â· 60% ì´í•˜ '+weak+'ê°œ';
  document.getElementById('statsSummary').textContent=sum;
}
function showByIndex(i){
  var s=getS(); if(!s || !s.decks.length) return;
  idx=(i+s.decks.length)%s.decks.length;
  document.getElementById('deckSelect').value=String(idx);
  var d=s.decks[idx];
  document.getElementById('qTitle').textContent=d.title;
  document.getElementById('qInfo').textContent='Â· í‚¤ì›Œë“œ '+d.keywords.length+'ê°œ';
  document.getElementById('answer').value='';
  document.getElementById('meterFill').style.width='0%';
  document.getElementById('statusBox').style.display='none';
  document.getElementById('miss').innerHTML='';
  var tox=document.getElementById('hintToggle').checked, hb=document.getElementById('hintBox');
  if(tox && d.ref){ var t=String(d.ref); hb.style.display='block'; hb.textContent = t.length>180? t.slice(0,180)+'â€¦':t; }
  else{ hb.style.display='none'; hb.textContent=''; }
  var st=s.stats[d.id]; document.getElementById('streakBadge').textContent=(st && st.attempts>0)?('ìµœê·¼ ì •ë‹µë¥  '+Math.round(st.lastScore*100)+'% Â· ì‹œë„ '+st.attempts+'íšŒ'):'ì •ë‹µë¥  â€”';
  document.getElementById('refWrap').style.display='none'; document.getElementById('refOut').textContent='';
}
function showNext(step){
  var s=getS(); if(!s || !s.decks.length) return;
  if(!weakMode || !pool.length){ showByIndex(idx+step); return; }
  var pIndex=pool.indexOf(idx); if(pIndex<0) pIndex=0;
  var nextIndex=(pIndex+(step>=0?1:-1)+pool.length)%pool.length;
  showByIndex(pool[nextIndex]);
}
function buildPool(){
  pool=[]; var s=getS(); if(!s) return;
  if(!weakMode){ for(var i=0;i<s.decks.length;i++) pool.push(i); }
  else{
    for(var j=0;j<s.decks.length;j++){
      var st=s.stats[s.decks[j].id];
      if(st && st.attempts>0 && st.lastScore<=0.6) pool.push(j);
    }
    if(pool.length===0){
      var sb=document.getElementById('statusBox');
      sb.style.display='flex'; sb.className='status ok';
      document.getElementById('statusIcon').textContent='ğŸ’«';
      document.getElementById('statusText').textContent='ë°˜ë³µí•™ìŠµ ëŒ€ìƒ(â‰¤60%)ì´ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ëª¨ë“œë¡œ ì§„í–‰í•´ ë³´ì„¸ìš”.';
    }
  }
}

/* ================= ì±„ì  (ìë™ì´ë™ ì—†ìŒ, ëˆ„ë½ ê°•ì¡°) ================= */
function grade(){
  var s=getS(); if(!s || idx<0) return;
  var d=s.decks[idx];
  var txt=String(document.getElementById('answer').value||'').toLowerCase();
  var hits=[], missed=[];
  for(var i=0;i<d.keywords.length;i++){
    var w=String(d.keywords[i]||'').toLowerCase();
    if(txt.indexOf(w)>-1) hits.push(d.keywords[i]); else missed.push(d.keywords[i]);
  }
  var ratio=d.keywords.length? (hits.length/d.keywords.length) : 0;
  document.getElementById('meterFill').style.width=Math.round(ratio*100)+'%';

  var box=document.getElementById('statusBox'), icon=document.getElementById('statusIcon'), text=document.getElementById('statusText');
  if(ratio>=0.7){ box.className='status ok'; icon.textContent='âœ…'; text.textContent='ì •ë‹µ â€” '+Math.round(ratio*100)+'% ('+hits.length+'/'+d.keywords.length+')'; }
  else if(ratio>0){ box.className='status warn'; icon.textContent='ğŸŸ¡'; text.textContent='ë¶€ë¶„ì •ë‹µ â€” '+Math.round(ratio*100)+'% ('+hits.length+'/'+d.keywords.length+')'; }
  else{ box.className='status ng'; icon.textContent='âŒ'; text.textContent='ì˜¤ë‹µ â€” 0%'; }
  box.style.display='flex';

  document.getElementById('miss').innerHTML = missed.length
    ? missed.map(function(k){return '<span class="miss-tag">'+escapeHtml(k)+'</span>';}).join('')
    : '<span class="note">ëˆ„ë½ ì—†ìŒ</span>';

  var st=s.stats[d.id]||{attempts:0,lastScore:0};
  st.attempts+=1; st.lastScore=ratio; s.stats[d.id]=st; save(); renderSummary();
  if(weakMode){ buildPool(); }
}

/* ================= ì „ì²´ ë Œë”/ì´ˆê¸°í™” ================= */
function renderAll(){
  var s=getS();
  document.getElementById('leftTitle').textContent = s ? ('ì„¸íŠ¸ ë§Œë“¤ê¸° â€” '+s.name) : 'ì„¸íŠ¸ ë§Œë“¤ê¸°';
  renderList(); buildPool(); if(s && s.decks.length){ showByIndex(0); } else { idx=-1; }
}

document.addEventListener('DOMContentLoaded',function(){
  migrateIfNeeded();
  try{ db = JSON.parse(localStorage.getItem(DB_KEY) || JSON.stringify(db)); }catch(e){}
  renderSubjectBar(); renderAll();

  // ì„¸íŠ¸ ì €ì¥/ìˆ˜ì •/ì‚­ì œ
  document.getElementById('saveBtn').onclick=function(){
    var s=getS(); if(!s) return;
    var t=document.getElementById('title').value.trim();
    var ks=parseKeywords(document.getElementById('keywords').value);
    var r=document.getElementById('refAnswer').value.trim();
    if(!t || !ks.length){ alert('ì œëª©ê³¼ ìµœì†Œ 1ê°œì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    var fi=-1; for(var i=0;i<s.decks.length;i++){ if(s.decks[i].title===t){fi=i;break;} }
    if(fi>-1){ s.decks[fi].keywords=ks; s.decks[fi].ref=r||undefined; }
    else{ s.decks.push({id:uid(), title:t, keywords:ks, ref:r||undefined}); }
    save(); renderList(); buildPool();
    document.getElementById('title').value=''; document.getElementById('keywords').value=''; document.getElementById('refAnswer').value='';
    if(s.decks.length===1){ showByIndex(0); }
  };
  document.getElementById('clearFormBtn').onclick=function(){
    document.getElementById('title').value=''; document.getElementById('keywords').value=''; document.getElementById('refAnswer').value='';
  };
  document.getElementById('list').onclick=function(e){
    var t=e.target; while(t && t.tagName!=='BUTTON'){ t=t.parentNode; } if(!t) return;
    var s=getS(); if(!s) return;
    var i=+t.getAttribute('data-i'); var act=t.getAttribute('data-act');
    if(act==='del'){
      if(confirm('ì‚­ì œí• ê¹Œìš”?')){
        var del=s.decks.splice(i,1)[0];
        if(del && s.stats[del.id]) delete s.stats[del.id];
        save(); renderList(); buildPool(); if(s.decks.length) showByIndex(0); else idx=-1;
      }
    }else if(act==='edit'){
      var d=s.decks[i]; if(!d) return;
      document.getElementById('title').value=d.title;
      document.getElementById('keywords').value=d.keywords.join(', ');
      document.getElementById('refAnswer').value=d.ref||'';
    }
  };

  // ë„¤ë¹„/ì±„ì /íŒíŠ¸
  document.getElementById('deckSelect').onchange=function(e){ showByIndex(+e.target.value); };
  document.getElementById('prevBtn').onclick=function(){ showNext(-1); };
  document.getElementById('nextBtn').onclick=function(){ showNext(+1); };
  document.getElementById('gradeBtn').onclick=grade;
  document.getElementById('showRefBtn').onclick=function(){
    var s=getS(); if(!s || idx<0) return; var d=s.decks[idx]; if(!d.ref){ alert('ì°¸ê³  ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    document.getElementById('refWrap').style.display='block'; document.getElementById('refOut').textContent=d.ref;
  };
  document.getElementById('hintToggle').onchange=function(){
    var s=getS(); if(!s || idx<0) return; var d=s.decks[idx]; var hb=document.getElementById('hintBox');
    if(this.checked && d && d.ref){ var t=String(d.ref); hb.style.display='block'; hb.textContent=t.length>180?t.slice(0,180)+'â€¦':t; }
    else{ hb.style.display='none'; hb.textContent=''; }
  };
  document.getElementById('weakOnly').onchange=function(){ weakMode=this.checked; buildPool(); var s=getS(); if(weakMode && s && pool.length) showByIndex(pool[0]); };

  // ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° (ì „ì²´ ê³¼ëª© êµ¬ì¡°)
  document.getElementById('exportBtn').onclick=function(){
    var name='recall-subjects-'+(new Date().getTime())+'.json';
    var blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name; a.click();
    setTimeout(function(){URL.revokeObjectURL(url);},1200);
  };
  document.getElementById('importFile').onchange=function(e){
    var f=e.target.files && e.target.files[0]; if(!f) return;
    var rd=new FileReader();
    rd.onload=function(){
      try{
        var data=JSON.parse(String(rd.result));
        if(!data || !data.subjects){ throw new Error('í˜•ì‹ ì˜¤ë¥˜(ê³¼ëª© êµ¬ì¡°ê°€ ì•„ë‹˜)'); }
        db=data; if(!db.subjects || !db.subjects.length){ db={active:0,subjects:[{id:uid(),name:'ê³¼ëª©1',decks:[],stats:{}}]}; }
        if(db.active<0 || db.active>=db.subjects.length) db.active=0;
        save(); renderSubjectBar(); renderAll();
      }catch(err){ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+err.message); }
    };
    rd.readAsText(f,'utf-8'); e.target.value='';
  };

  // ë‹¨ì¶•í‚¤: Ctrl/Cmd + Enter = ì±„ì 
  window.addEventListener('keydown', function(ev){
    var enter=(ev.key==='Enter'||ev.keyCode===13);
    if((ev.ctrlKey||ev.metaKey) && enter){ grade(); ev.preventDefault(); }
  });
});
</script>
</body>
</html>
